<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Customer Biznet Branch Kalianda</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <header class="app-header">
        <div class="container d-flex justify-content-between align-items-center">
            <img src="logo-biznet-blue-trans.png" alt="Biznet Logo" class="app-logo"> 
            <h1 class="app-title">Data Customer Biznet Branch Kalianda</h1>
            <div>
                <button id="toggleCustomerDashboardBtn" class="btn btn-outline-light toggle-dashboard-btn mr-2" title="Toggle Customer Analytics">
                    <i class="fas fa-users"></i> Customer
                </button>
                <button id="toggleRevenueDashboardBtn" class="btn btn-outline-light toggle-dashboard-btn" title="Toggle Revenue Analytics">
                    <i class="fas fa-dollar-sign"></i> Revenue
                </button>
            </div>
        </div>
    </header>

    <div class="container mt-4 main-content">
        <div class="card p-4 shadow-sm mb-4">
            <div class="row mb-3 align-items-end">
                <div class="col-md-5">
                    <label for="searchInput" class="form-label">Pencarian Customer:</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" id="searchInput" placeholder="Cari berdasarkan nama, email, atau ID...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Filter Status:</label>
                    <select class="form-control" id="statusFilter">
                        <option value="">Semua Status</option>
                        </select>
                </div>
                <div class="col-md-3">
                    <label for="salesCodeFilter" class="form-label">Filter Sales Code:</label>
                    <select class="form-control" id="salesCodeFilter">
                        <option value="">Semua Sales Code</option>
                        </select>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-outline-secondary btn-block" id="resetFilters" title="Reset Filter"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
        </div>
        
        <div id="customerCount" class="alert alert-info text-center"></div>

        <div class="container mt-5 dashboard-section d-none" id="customerDashboardSection">
            <h2 class="section-title">Analisis Data Customer</h2>

            <div class="card p-4 shadow-sm mb-4">
                <h3 class="card-title">Status Customer per Sales Code</h3>
                <div id="salesCodeStatusDashboard" class="row">
                    <p class="text-muted text-center col-12">Memuat data analisis status...</p>
                </div>
            </div>

            <div class="card p-4 shadow-sm mb-4">
                <h3 class="card-title">Distribusi Customer per Sales Code (Berdasarkan Kecamatan)</h3>
                <div id="salesCodeSubdistrictDashboard" class="row">
                    <p class="text-muted text-center col-12">Memuat data analisis kecamatan...</p>
                </div>
            </div>

            <div class="card p-4 shadow-sm mb-4">
                <h3 class="card-title">Customer Baru per Bulan (per Sales Code)</h3>
                <div id="monthlyNewCustomersDashboard" class="row">
                    <div class="col-12 chart-card-lg"> 
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
            </div>

        </div>
        <div class="container mt-5 dashboard-section d-none" id="revenueDashboardSection">
            <h2 class="section-title">Analisis Data Revenue</h2>

            <div class="card p-4 shadow-sm mb-4">
                <h3 class="card-title">Revenue per Kuartal</h3>
                <div class="col-12 chart-card-lg"> 
                    <canvas id="quarterlyRevenueChart"></canvas>
                </div>
            </div>

            <div class="card p-4 shadow-sm mb-4">
                <h3 class="card-title">Revenue per Bulan</h3>
                <div class="col-12 chart-card-lg"> 
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
            </div>

        </div>
        <div class="table-responsive app-table-container">
            <table id="customerTable" class="table table-striped table-bordered table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>BUSINESSPARTNERID</th>
                        <th>BP_FULLNAME</th>
                        <th>BP_EMAIL</th>
                        <th>BP_PHONE</th>
                        <th>CONTRACTACCOUNT</th>
                        <th>BILLING_NAME</th>
                        <th>BILLING_EMAIL</th>
                        <th>BILLING_PHONE</th>
                        <th>CONTRACTNUMBER</th>
                        <th>SERVICE_TYPE</th>
                        <th>SALESCODE</th>
                        <th>BRANCH_FROM_SALESCODE</th>
                        <th>RO_FROM_SALESCODE</th>
                        <th>SM_FROM_SALESCODE</th>
                        <th>BUNDLE_LOB</th>
                        <th>BUNDLE_ID</th>
                        <th>BUNDLE_NAME</th>
                        <th>MODEM_STATUS</th>
                        <th>PROMO_CODE</th>
                        <th>CONTRACTSTARTDATE</th>
                        <th>EXPIREDDATE</th>
                        <th>STATUS</th>
                        <th>TERMDATE</th>
                        <th>ADDRESSID</th>
                        <th>ADDRESSTYPE</th>
                        <th>ADDRESSID_INST</th>
                        <th>SUBDISTRICT_INST</th>
                        <th>DISTRICT_INST</th>
                        <th>CITY_INST</th>
                        <th>STATE_INST</th>
                        <th>INSTALLATION_ADDRESS1</th>
                        <th>INSTALLATION_ADDRESS2</th>
                        <th>INSTALLATION_ADDRESS3</th>
                        <th>INSTALLATION_ADDRESS4</th>
                        <th>MATERIAL_NAME</th>
                        <th>MATERIAL_DESCRIPTION</th>
                        <th>TOTAL_TICKET</th>
                        <th>MODEM_TYPE</th>
                        <th>DEVICE_MODEL</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="39" class="text-center">Memuat data customer...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="errorMessage" class="alert alert-danger d-none mt-3" role="alert">
            Gagal memuat data customer. Pastikan Google Sheet Anda dapat diakses dan Apps Script berjalan dengan benar.
        </div>
    </div>

    <div class="modal fade" id="vaModal" tabindex="-1" aria-labelledby="vaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vaModalLabel">Informasi Virtual Account</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="vaContentToCapture">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="downloadVaJpgBtn"><i class="fas fa-download"></i> Download sebagai JPG</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="monthlyCustomerDetailModal" tabindex="-1" aria-labelledby="monthlyCustomerDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="monthlyCustomerDetailModalLabel">Detail Customer Baru</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h6 id="monthlyDetailTitle" class="text-center mb-3"></h6>
                    <div class="table-responsive">
                        <table id="monthlyCustomerDetailTable" class="table table-striped table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>BUSINESSPARTNERID</th>
                                    <th>BP_FULLNAME</th>
                                    <th>BP_EMAIL</th>
                                    <th>BP_PHONE</th>
                                    <th>CONTRACTSTARTDATE</th>
                                    <th>SALESCODE</th>
                                    <th>STATUS</th>
                                    <th>SUBDISTRICT_INST</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // PASTIKAN URL INI SESUAI DENGAN URL WEB APP CUSTOMER DATA ANDA
        const customerWebAppUrl = 'URL_WEB_APP_CUSTOMER_ANDA'; 
        // PASTE URL WEB APP REVENUE DATA ANDA DI SINI!
        const revenueWebAppUrl = 'https://script.google.com/macros/s/AKfycbwN0YEMIOeoHfnQopeY0SePSle5zL1LW_XkQd6Z-Yw95XM-GFrkxWZxQCl8AfsFhYn7xQ/exec'; 
        
        // Mapping Sales Code ke Nama Sales Person
        const salesCodeNames = {
            '200602': 'Riski Aprianto',
            '200603': 'Habibi',
            '200604': 'Ananda Ilham Hakiki',
            // Tambahkan sales code lain jika ada
        };

        let allCustomerData = []; 
        let allRevenueData = []; 
        let filteredCustomerData = []; 
        let salesCodeCharts = {}; 
        let subdistrictCharts = {};
        let monthlySalesChartInstance = null; 
        let quarterlyRevenueChartInstance = null; 
        let monthlyRevenueChartInstance = null;   


        async function fetchCustomerData() {
            const tableBody = document.getElementById('customerTable').getElementsByTagName('tbody')[0];
            const errorMessageDiv = document.getElementById('errorMessage');
            const customerCountDiv = document.getElementById('customerCount'); 

            tableBody.innerHTML = '<tr><td colspan="39" class="text-center"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div> Memuat data customer...</td></tr>';
            errorMessageDiv.classList.add('d-none'); 
            customerCountDiv.textContent = 'Memuat jumlah customer...'; 

            // Clear customer dashboards while loading
            document.getElementById('salesCodeStatusDashboard').innerHTML = '<p class="text-muted text-center col-12">Memuat data analisis status...</p>';
            document.getElementById('salesCodeSubdistrictDashboard').innerHTML = '<p class="text-muted text-center col-12">Memuat data analisis kecamatan...</p>';
            document.getElementById('monthlyNewCustomersDashboard').innerHTML = '<div class="col-12 chart-card-lg"><p class="text-muted text-center">Memuat data analisis penjualan bulanan...</p></div>';
            
            // Clear revenue dashboards while loading and recreate canvas
            document.getElementById('quarterlyRevenueChart').parentNode.innerHTML = '<canvas id="quarterlyRevenueChart"></canvas><p class="text-muted text-center">Memuat data revenue kuartalan...</p>';
            document.getElementById('monthlyRevenueChart').parentNode.innerHTML = '<canvas id="monthlyRevenueChart"></canvas><p class="text-muted text-center">Memuat data revenue bulanan...</p>';


            try {
                // Fetch Customer Data
                const customerResponse = await fetch(customerWebAppUrl);
                if (!customerResponse.ok) {
                    throw new Error(`HTTP error! status: ${customerResponse.status} for customer data`);
                }
                const customerData = await customerResponse.json();
                if (customerData.error) {
                    throw new Error(customerData.error);
                }
                allCustomerData = customerData; 
                populateFilters(allCustomerData); 
                applyFiltersAndSearch(); 
                renderSalesCodeStatusDashboard(allCustomerData);
                renderSalesCodeSubdistrictDashboard(allCustomerData);
                renderMonthlySalesChart(allCustomerData); 

                // Fetch Revenue Data
                const revenueResponse = await fetch(revenueWebAppUrl);
                if (!revenueResponse.ok) {
                    throw new Error(`HTTP error! status: ${revenueResponse.status} for revenue data`);
                }
                const revenueData = await revenueResponse.json();
                if (revenueData.error) {
                    throw new Error(revenueData.error);
                }
                allRevenueData = revenueData;
                renderQuarterlyRevenueChart(allRevenueData); 
                renderMonthlyRevenueChart(allRevenueData);   


                errorMessageDiv.classList.add('d-none'); 
            } catch (error) {
                console.error('Error fetching data:', error);
                tableBody.innerHTML = '<tr><td colspan="39" class="text-center text-danger">Error memuat data.</td></tr>';
                errorMessageDiv.textContent = `Gagal memuat data: ${error.message}. Pastikan Google Sheet Anda dapat diakses dan Apps Script berjalan dengan benar.`;
                errorMessageDiv.classList.remove('d-none'); 
                customerCountDiv.textContent = 'Gagal memuat jumlah customer.'; 
                
                // Clear dashboards on error
                document.getElementById('salesCodeStatusDashboard').innerHTML = '<p class="text-danger text-center col-12">Gagal memuat data analisis status.</p>';
                document.getElementById('salesCodeSubdistrictDashboard').innerHTML = '<p class="text-danger text-center col-12">Gagal memuat data analisis kecamatan.</p>';
                document.getElementById('monthlyNewCustomersDashboard').innerHTML = '<div class="col-12 chart-card-lg"><p class="text-danger text-center">Gagal memuat data analisis penjualan bulanan.</p></div>';
                
                document.getElementById('quarterlyRevenueChart').parentNode.innerHTML = '<canvas id="quarterlyRevenueChart"></canvas><p class="text-danger text-center">Gagal memuat data revenue kuartalan.</p>';
                document.getElementById('monthlyRevenueChart').parentNode.innerHTML = '<canvas id="monthlyRevenueChart"></canvas><p class="text-danger text-center">Gagal memuat data revenue bulanan.</p>';

            }
        }

        function populateFilters(data) {
            const statusFilter = document.getElementById('statusFilter');
            const salesCodeFilter = document.getElementById('salesCodeFilter');

            const uniqueStatuses = new Set();
            const uniqueSalesCodes = new Set();

            data.forEach(customer => {
                if (customer.STATUS) uniqueStatuses.add(customer.STATUS);
                if (customer.SALESCODE) uniqueSalesCodes.add(customer.SALESCODE);
            });

            statusFilter.innerHTML = '<option value="">Semua Status</option>';
            Array.from(uniqueStatuses).sort().forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });

            salesCodeFilter.innerHTML = '<option value="">Semua Sales Code</option>';
            Array.from(uniqueSalesCodes).sort().forEach(salesCode => {
                const option = document.createElement('option');
                option.value = salesCode;
                option.textContent = `${salesCodeNames[salesCode] ? salesCodeNames[salesCode] + ' (' : ''}${salesCode}${salesCodeNames[salesCode] ? ')' : ''}`; // Menampilkan Sales Code dan Nama Sales Person
                salesCodeFilter.appendChild(option);
            });
        }

        function applyFiltersAndSearch() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const selectedStatus = document.getElementById('statusFilter').value;
            const selectedSalesCode = document.getElementById('salesCodeFilter').value;

            filteredCustomerData = allCustomerData.filter(customer => {
                const matchesSearch = searchInput === '' ||
                                      (customer.BP_FULLNAME && customer.BP_FULLNAME.toLowerCase().includes(searchInput)) ||
                                      (customer.BP_EMAIL && customer.BP_EMAIL.toLowerCase().includes(searchInput)) ||
                                      (customer.BUSINESSPARTNERID && String(customer.BUSINESSPARTNERID).toLowerCase().includes(searchInput));

                const matchesStatus = selectedStatus === '' || (customer.STATUS && customer.STATUS === selectedStatus);

                const matchesSalesCode = selectedSalesCode === '' || (customer.SALESCODE && customer.SALESCODE === selectedSalesCode);

                return matchesSearch && matchesStatus && matchesSalesCode;
            });

            renderTable(filteredCustomerData);
            updateCustomerCount(filteredCustomerData.length, allCustomerData.length); 
        }

        function renderTable(dataToRender) {
            const tableBody = document.getElementById('customerTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; 

            if (dataToRender.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="39" class="text-center">Tidak ada data yang ditemukan.</td></tr>';
                return;
            }

            const headers = [
                'BUSINESSPARTNERID', 'BP_FULLNAME', 'BP_EMAIL', 'BP_PHONE', 'CONTRACTACCOUNT', 
                'BILLING_NAME', 'BILLING_EMAIL', 'BILLING_PHONE', 'CONTRACTNUMBER', 
                'SERVICE_TYPE', 'SALESCODE', 'BRANCH_FROM_SALESCODE', 'RO_FROM_SALESCODE', 
                'SM_FROM_SALESCODE', 'BUNDLE_LOB', 'BUNDLE_ID', 'BUNDLE_NAME', 'MODEM_STATUS', 
                'PROMO_CODE', 'CONTRACTSTARTDATE', 'EXPIREDDATE', 'STATUS', 'TERMDATE', 
                'ADDRESSID', 'ADDRESSTYPE', 'ADDRESSID_INST', 'SUBDISTRICT_INST', 
                'DISTRICT_INST', 'CITY_INST', 'STATE_INST', 'INSTALLATION_ADDRESS1', 
                'INSTALLATION_ADDRESS2', 'INSTALLATION_ADDRESS3', 'INSTALLATION_ADDRESS4', 
                'MATERIAL_NAME', 'MATERIAL_DESCRIPTION', 'TOTAL_TICKET', 'MODEM_TYPE', 'DEVICE_MODEL'
            ];

            dataToRender.forEach(customer => {
                let row = tableBody.insertRow();
                row.dataset.customerData = JSON.stringify(customer); 
                
                headers.forEach(header => {
                    let cell = row.insertCell();
                    if (header.includes('DATE') && customer[header]) {
                        try {
                            const date = new Date(customer[header]);
                            cell.textContent = date.toLocaleDateString('id-ID'); 
                        } catch (e) {
                            cell.textContent = customer[header] ?? ''; 
                        }
                    } else {
                        cell.textContent = customer[header] ?? ''; 
                    }
                });
            });
        }

        function updateCustomerCount(filteredCount, totalCount) {
            const customerCountDiv = document.getElementById('customerCount');
            if (filteredCount === totalCount) {
                customerCountDiv.innerHTML = `<strong>Total Customer: ${totalCount}</strong>`;
            } else {
                customerCountDiv.innerHTML = `<strong>Menampilkan ${filteredCount} dari ${totalCount} Customer.</strong>`;
            }
        }

        function showVaInfo(customer) {
            const vaContentToCapture = document.getElementById('vaContentToCapture');
            const contractAccount = customer.CONTRACTACCOUNT || '';
            const bpFullName = customer.BP_FULLNAME || 'Tidak Diketahui';
            let expiredDate = customer.EXPIREDDATE;
            const bundleName = customer.BUNDLE_NAME || ''; 

            if (expiredDate) {
                try {
                    const date = new Date(expiredDate);
                    expiredDate = date.toLocaleDateString('id-ID'); 
                } catch (e) {
                    // Biarkan apa adanya jika gagal diformat
                }
            } else {
                expiredDate = 'Tidak Diketahui';
            }

            let vaContentHtml = '';

            // Check if BUNDLE_NAME contains "Metronet" (case-insensitive)
            if (bundleName.toLowerCase().includes('metronet')) {
                vaContentHtml = `
                    <div class="va-card">
                        <img src="logo-biznet-blue-trans.png" alt="Biznet Logo" class="va-biznet-logo"> 
                        <p class="va-title">Pembayaran melalui Virtual Account</p>
                        <p class="va-title">Payment via Virtual Account</p>
                        <p class="va-customer-info"><strong>Nama Customer:</strong> ${bpFullName}</p>
                        <p class="va-customer-info"><strong>Masa aktif sampai:</strong> ${expiredDate}</p>
                        <hr>
                        <p class="va-bank"><strong>BCA:</strong> <br><code>711160-${contractAccount}</code></p>
                        <p class="va-bank"><strong>Bank Permata:</strong> <br><code>883100-${contractAccount}</code></p>
                        <p class="va-bank"><strong>Bank Mandiri:</strong> <br><code>895912-${contractAccount}</code></p>
                        <p class="va-bank"><strong>OCBC:</strong> <br><code>903022-${contractAccount}</code></p>
                    </div>
                `;
            } else {
                // Default VA info for non-Metronet bundles
                vaContentHtml = `
                    <div class="va-card">
                        <img src="logo-biznet-blue-trans.png" alt="Biznet Logo" class="va-biznet-logo"> 
                        <p class="va-title">Berikut nomor Virtual Account Pembayarannya:</p>
                        <p class="va-customer-info"><strong>Nama Customer:</strong> ${bpFullName}</p>
                        <p class="va-customer-info"><strong>Masa aktif sampai:</strong> ${expiredDate}</p>
                        <hr>
                        <p class="va-bank"><strong>Bank Permata Virtual Account:</strong> <br><code>899300-${contractAccount}</code></p>
                        <p class="va-bank"><strong>Bank BCA Virtual Account:</strong> <br><code>711170-${contractAccount}</code></p>
                        <p class="va-bank"><strong>Bank Mandiri Virtual Account:</strong> <br><code>895911-${contractAccount}</code></p>
                        <p class="va-other-methods"><strong>MBanking UOB / Indomaret / Alfamart / Alfamidi / CK / GoPay / Tokopedia / BRIMO / DANA:</strong> <br>Billing ID: <code>${contractAccount}</code></p>
                    </div>
                `;
            }

            vaContentToCapture.innerHTML = vaContentHtml;
            $('#vaModal').modal('show'); 
        }

        document.getElementById('downloadVaJpgBtn').addEventListener('click', () => {
            const vaContent = document.getElementById('vaContentToCapture');
            const customerNameElement = vaContent.querySelector('.va-customer-info:first-of-type strong');
            const customerName = customerNameElement ? customerNameElement.nextSibling.textContent.trim() : 'Customer'; 

            const options = {
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff', 
            };

            html2canvas(vaContent, options).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.9); 
                const link = document.createElement('a');
                link.download = `VA_${customerName.replace(/[^a-zA-Z0-9_]/g, '')}.jpg`; 
                link.href = imgData;
                link.click();
            }).catch(error => {
                console.error('Error generating image:', error);
                alert('Gagal membuat gambar VA. Silakan coba lagi.');
            });
        });

        // ===========================================
        // DASHBOARD JAVASCRIPT FUNCTIONS START
        // ===========================================

        function renderSalesCodeStatusDashboard(data) {
            const dashboardDiv = document.getElementById('salesCodeStatusDashboard');
            dashboardDiv.innerHTML = ''; 

            const statusCounts = {}; 

            data.forEach(customer => {
                const salesCode = customer.SALESCODE || 'Unknown Sales Code';
                const status = customer.STATUS || 'Unknown Status';

                if (!statusCounts[salesCode]) {
                    statusCounts[salesCode] = {};
                }
                statusCounts[salesCode][status] = (statusCounts[salesCode][status] || 0) + 1;
            });

            const sortedSalesCodes = Object.keys(statusCounts).sort();

            if (sortedSalesCodes.length === 0) {
                dashboardDiv.innerHTML = '<p class="text-muted text-center col-12">Tidak ada data Sales Code untuk analisis status.</p>';
                return;
            }

            for (const key in salesCodeCharts) {
                if (salesCodeCharts[key]) {
                    salesCodeCharts[key].destroy();
                }
            }
            salesCodeCharts = {};

            sortedSalesCodes.forEach(salesCode => {
                const salesCodeData = statusCounts[salesCode];
                const labels = Object.keys(salesCodeData).sort(); 
                const counts = labels.map(label => salesCodeData[label]);

                const totalCustomers = counts.reduce((sum, current) => sum + current, 0);
                if (totalCustomers === 0) return; 

                // Mendapatkan nama sales person
                const salesPersonName = salesCodeNames[salesCode] ? ` (${salesCodeNames[salesCode]})` : '';

                const chartContainer = document.createElement('div');
                chartContainer.className = 'col-lg-4 col-md-6 col-sm-12 mb-4'; 
                chartContainer.innerHTML = `<div class="chart-card card p-3">
                                                <h5 class="card-title text-center mb-3">Sales Code: ${salesCode}${salesPersonName} (${totalCustomers} Customer)</h5>
                                                <canvas id="statusChart_${salesCode}"></canvas>
                                            </div>`;
                dashboardDiv.appendChild(chartContainer);

                const ctx = document.getElementById(`statusChart_${salesCode}`).getContext('2d');
                
                const backgroundColors = labels.map(label => {
                    switch(label.toLowerCase()) {
                        case 'active': return '#28a745'; 
                        case 'terminated': return '#dc3545'; 
                        case 'suspended': return '#ffc107'; 
                        default: return '#6c757d'; 
                    }
                });

                salesCodeCharts[salesCode] = new Chart(ctx, {
                    type: 'doughnut', 
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: backgroundColors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 15,
                                    padding: 10
                                }
                            },
                            title: {
                                display: false, 
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(tooltipItem) {
                                        let label = tooltipItem.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += tooltipItem.raw + ' (' + ((tooltipItem.raw / totalCustomers) * 100).toFixed(2) + '%)';
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        function renderSalesCodeSubdistrictDashboard(data) {
            const dashboardDiv = document.getElementById('salesCodeSubdistrictDashboard');
            dashboardDiv.innerHTML = ''; 

            const subdistrictCounts = {}; 

            data.forEach(customer => {
                const salesCode = customer.SALESCODE || 'Unknown Sales Code';
                const subdistrict = customer.SUBDISTRICT_INST || 'Unknown Subdistrict';

                if (!subdistrictCounts[salesCode]) {
                    subdistrictCounts[salesCode] = {};
                }
                subdistrictCounts[salesCode][subdistrict] = (subdistrictCounts[salesCode][subdistrict] || 0) + 1;
            });

            const sortedSalesCodes = Object.keys(subdistrictCounts).sort();

            if (sortedSalesCodes.length === 0) {
                dashboardDiv.innerHTML = '<p class="text-muted text-center col-12">Tidak ada data Sales Code untuk analisis kecamatan.</p>';
                return;
            }

            for (const key in subdistrictCharts) {
                if (subdistrictCharts[key]) {
                    subdistrictCharts[key].destroy();
                }
            }
            subdistrictCharts = {};

            sortedSalesCodes.forEach(salesCode => {
                const salesCodeData = subdistrictCounts[salesCode];
                const sortedSubdistricts = Object.entries(salesCodeData)
                                                .sort(([,countA], [,countB]) => countB - countA) 
                                                .slice(0, 10); 

                if (sortedSubdistricts.length === 0) return; 

                const labels = sortedSubdistricts.map(entry => entry[0]);
                const counts = sortedSubdistricts.map(entry => entry[1]);

                // Mendapatkan nama sales person
                const salesPersonName = salesCodeNames[salesCode] ? ` (${salesCodeNames[salesCode]})` : '';

                const chartContainer = document.createElement('div');
                chartContainer.className = 'col-lg-6 col-md-12 mb-4'; 
                chartContainer.innerHTML = `<div class="chart-card card p-3">
                                                <h5 class="card-title text-center mb-3">Sales Code: ${salesCode}${salesPersonName} - Top 10 Kecamatan</h5>
                                                <canvas id="subdistrictChart_${salesCode}"></canvas>
                                            </div>`;
                dashboardDiv.appendChild(chartContainer);

                const ctx = document.getElementById(`subdistrictChart_${salesCode}`).getContext('2d');
                
                subdistrictCharts[salesCode] = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Customer',
                            data: counts,
                            backgroundColor: 'rgba(0, 123, 255, 0.7)', 
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', 
                        plugins: {
                            legend: {
                                display: false, 
                            },
                            title: {
                                display: false, 
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0 
                                }
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        }

        function renderMonthlySalesChart(data) {
            const dashboardDiv = document.getElementById('monthlyNewCustomersDashboard');
            // Recreate canvas to prevent Chart.js issues
            dashboardDiv.innerHTML = '<div class="col-12 chart-card-lg"><canvas id="monthlySalesChart"></canvas></div>'; 

            const monthlySales = {}; 
            const salesCodes = new Set();

            data.forEach(customer => {
                const contractStartDate = customer.CONTRACTSTARTDATE;
                const salesCode = customer.SALESCODE || 'Unknown Sales Code';

                if (contractStartDate) {
                    try {
                        const date = new Date(contractStartDate);
                        const year = date.getFullYear();
                        const month = date.getMonth() + 1; 
                        const monthKey = `${year}-${String(month).padStart(2, '0')}`; 

                        if (!monthlySales[monthKey]) {
                            monthlySales[monthKey] = {};
                        }
                        monthlySales[monthKey][salesCode] = (monthlySales[monthKey][salesCode] || 0) + 1;
                        salesCodes.add(salesCode);
                    } catch (e) {
                        console.warn('Invalid CONTRACTSTARTDATE format:', contractStartDate, e);
                    }
                }
            });

            const sortedMonths = Object.keys(monthlySales).sort();
            const sortedSalesCodes = Array.from(salesCodes).sort();

            if (sortedMonths.length === 0 || sortedSalesCodes.length === 0) {
                dashboardDiv.innerHTML = '<div class="col-12 chart-card-lg"><p class="text-muted text-center">Tidak ada data penjualan bulanan.</p></div>';
                return;
            }

            if (monthlySalesChartInstance) {
                monthlySalesChartInstance.destroy();
            }

            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            const datasets = [];

            const generateColor = (index) => {
                const colors = [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#fd7e14', '#e83e8c', '#6c757d', '#20c997'
                ];
                return colors[index % colors.length];
            };

            sortedSalesCodes.forEach((salesCode, index) => {
                const dataPoints = sortedMonths.map(month => monthlySales[month][salesCode] || 0);
                const color = generateColor(index);
                const salesPersonName = salesCodeNames[salesCode] ? ` (${salesCodeNames[salesCode]})` : ''; // Mendapatkan nama sales
                datasets.push({
                    label: `${salesCode}${salesPersonName}`, // Menggabungkan sales code dan nama sales
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color + '40', 
                    fill: false,
                    tension: 0.1, 
                    borderWidth: 2
                });
            });

            monthlySalesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false, 
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(tooltipItem) {
                                    const label = tooltipItem.dataset.label || '';
                                    const value = tooltipItem.raw;
                                    return `${label}: ${value} Customer`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Customer Baru'
                            },
                            ticks: {
                                precision: 0 
                            }
                        }
                    },
                    onClick: (evt, element) => {
                        if (element.length > 0) {
                            const datasetIndex = element[0].datasetIndex;
                            const index = element[0].index;
                            const labelMonth = monthlySalesChartInstance.data.labels[index];
                            const salesCodeClickedWithAlias = monthlySalesChartInstance.data.datasets[datasetIndex].label;
                            // Ekstrak hanya sales code dari label alias (misal "200602 (Riski Aprianto)")
                            const salesCodeClicked = salesCodeClickedWithAlias.split(' ')[0];
                            showMonthlyCustomerDetails(labelMonth, salesCodeClicked);
                        }
                    }
                }
            });
        }

        function showMonthlyCustomerDetails(monthYear, salesCode) {
            const [year, month] = monthYear.split('-');
            const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
            const salesPersonName = salesCodeNames[salesCode] ? ` (${salesCodeNames[salesCode]})` : ''; // Mendapatkan nama sales

            document.getElementById('monthlyDetailTitle').textContent = `Customer Baru untuk Sales Code: ${salesCode}${salesPersonName} di Bulan ${monthName}`;
            const detailTableBody = document.getElementById('monthlyCustomerDetailTable').getElementsByTagName('tbody')[0];
            detailTableBody.innerHTML = ''; 

            const filteredDetails = allCustomerData.filter(customer => {
                if (!customer.CONTRACTSTARTDATE || !customer.SALESCODE) return false;

                try {
                    const date = new Date(customer.CONTRACTSTARTDATE);
                    const customerMonthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return customerMonthKey === monthYear && customer.SALESCODE === salesCode;
                } catch (e) {
                    return false;
                }
            });

            if (filteredDetails.length === 0) {
                detailTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Tidak ada customer ditemukan untuk kriteria ini.</td></tr>';
            } else {
                filteredDetails.forEach(customer => {
                    let row = detailTableBody.insertRow();
                    row.insertCell().textContent = customer.BUSINESSPARTNERID ?? '';
                    row.insertCell().textContent = customer.BP_FULLNAME ?? '';
                    row.insertCell().textContent = customer.BP_EMAIL ?? '';
                    row.insertCell().textContent = customer.BP_PHONE ?? '';
                    row.insertCell().textContent = customer.CONTRACTSTARTDATE ? new Date(customer.CONTRACTSTARTDATE).toLocaleDateString('id-ID') : '';
                    row.insertCell().textContent = customer.SALESCODE ?? '';
                    row.insertCell().textContent = customer.STATUS ?? '';
                    row.insertCell().textContent = customer.SUBDISTRICT_INST ?? '';
                });
            }

            $('#monthlyCustomerDetailModal').modal('show');
        }

        // --- REVENUE CHART FUNCTIONS ---

        function renderQuarterlyRevenueChart(data) {
            const chartCanvasContainer = document.getElementById('quarterlyRevenueChart').parentNode;
            chartCanvasContainer.innerHTML = '<canvas id="quarterlyRevenueChart"></canvas>'; // Recreate canvas element
            const ctx = document.getElementById('quarterlyRevenueChart').getContext('2d');

            const quarterlyRevenue = {}; // { 'YYYY-Qn': totalRevenue }

            data.forEach(item => {
                const year = item.tahun; 
                const quarter = item.quartal; 
                const revenue = parseFloat(item.revenue) || 0; 

                if (year && quarter) {
                    const quarterKey = `${year}-${quarter}`;
                    quarterlyRevenue[quarterKey] = (quarterlyRevenue[quarterKey] || 0) + revenue;
                }
            });

            const sortedQuarters = Object.keys(quarterlyRevenue).sort();
            const labels = sortedQuarters.map(key => key); // e.g., "2023-Q1"
            const revenues = sortedQuarters.map(key => quarterlyRevenue[key]);

            if (quarterlyRevenueChartInstance) {
                quarterlyRevenueChartInstance.destroy();
            }

            quarterlyRevenueChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Revenue',
                        data: revenues,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return 'Revenue: ' + tooltipItem.raw.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Kuartal'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Revenue (IDR)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    // Format tick labels as IDR without currency symbol for readability on axis
                                    return value.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); 
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMonthlyRevenueChart(data) {
            const chartCanvasContainer = document.getElementById('monthlyRevenueChart').parentNode;
            chartCanvasContainer.innerHTML = '<canvas id="monthlyRevenueChart"></canvas>'; // Recreate canvas element
            const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');

            const monthlyRevenue = {}; // { 'YYYY-MM': totalRevenue }

            data.forEach(item => {
                const year = item.tahun;
                const monthName = item.bulan;
                const revenue = parseFloat(item.revenue) || 0;

                // Map month name to month number (0-11 for Date object, 1-12 for MM format)
                const monthNames = ["jan", "feb", "mar", "apr", "mei", "jun", "jul", "agu", "sep", "okt", "nov", "des"];
                const monthNum = monthNames.indexOf(monthName.toLowerCase()); // 0-indexed for Date object

                if (year && monthNum !== -1) {
                    const monthKey = `${year}-${String(monthNum + 1).padStart(2, '0')}`; // YYYY-MM format for sorting
                    monthlyRevenue[monthKey] = (monthlyRevenue[monthKey] || 0) + revenue;
                }
            });

            const sortedMonths = Object.keys(monthlyRevenue).sort();
            const labels = sortedMonths.map(key => {
                const [year, month] = key.split('-');
                const date = new Date(year, parseInt(month) - 1, 1); // Month is 0-indexed for Date
                return date.toLocaleString('id-ID', { month: 'short', year: 'numeric' }); // e.g., "Jun 2023"
            });
            const revenues = sortedMonths.map(key => monthlyRevenue[key]);

            if (monthlyRevenueChartInstance) {
                monthlyRevenueChartInstance.destroy();
            }

            monthlyRevenueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Revenue',
                        data: revenues,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.4)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return 'Revenue: ' + tooltipItem.raw.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Revenue (IDR)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return value.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                }
                            }
                        }
                    }
                }
            });
        }


        // ===========================================
        // DASHBOARD JAVASCRIPT FUNCTIONS END
        // ===========================================


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchCustomerData(); 

            document.getElementById('searchInput').addEventListener('keyup', applyFiltersAndSearch);
            document.getElementById('statusFilter').addEventListener('change', applyFiltersAndSearch);
            document.getElementById('salesCodeFilter').addEventListener('change', applyFiltersAndSearch);
            document.getElementById('resetFilters').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('salesCodeFilter').value = '';
                applyFiltersAndSearch();
            });

            document.getElementById('customerTable').addEventListener('click', (event) => {
                const clickedRow = event.target.closest('tr'); 
                if (clickedRow && clickedRow.dataset.customerData) {
                    const customer = JSON.parse(clickedRow.dataset.customerData);
                    showVaInfo(customer);
                }
            });

            // New: Toggle buttons for dashboards
            const customerDashboardSection = document.getElementById('customerDashboardSection');
            const revenueDashboardSection = document.getElementById('revenueDashboardSection');

            document.getElementById('toggleCustomerDashboardBtn').addEventListener('click', () => {
                customerDashboardSection.classList.toggle('d-none');
                revenueDashboardSection.classList.add('d-none'); // Hide revenue if customer is shown
            });

            document.getElementById('toggleRevenueDashboardBtn').addEventListener('click', () => {
                revenueDashboardSection.classList.toggle('d-none');
                customerDashboardSection.classList.add('d-none'); // Hide customer if revenue is shown
            });

            // Initially show customer dashboard, hide revenue dashboard
            customerDashboardSection.classList.remove('d-none');
            revenueDashboardSection.classList.add('d-none');
        });

    </script>
</body>
</html>
