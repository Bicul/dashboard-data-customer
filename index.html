<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data Customer Biznet</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>
    <div class="wrapper">
        <nav id="sidebar">
            <div class="sidebar-header">
                <img src="logo-biznet-blue-trans.png" alt="Biznet Logo" class="sidebar-logo">
                <h3>Biznet Data</h3>
            </div>
            <ul class="list-unstyled components">
                <p>Navigasi</p>
                <li class="active">
                    <a href="#" onclick="showSection('customerOverview')">
                        <i class="fas fa-users"></i> Customer Overview
                    </a>
                </li>
                <li>
                    <a href="#analysisSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                        <i class="fas fa-chart-bar"></i> Analisis
                    </a>
                    <ul class="collapse list-unstyled" id="analysisSubmenu">
                        <li>
                            <a href="#" onclick="showSection('newCustomerAnalysis')">Customer Baru per Bulan</a>
                        </li>
                        <li>
                            <a href="#" onclick="showSection('customerStatusAnalysis')">Status Customer</a>
                        </li>
                        <li>
                            <a href="#" onclick="showSection('kecamatanAnalysis')">Distribusi per Kecamatan</a>
                        </li>
                        <li>
                            <a href="#" onclick="showSection('bundleNameAnalysis')">Analisis Bundle Name</a>
                        </li>
                        <li>
                            <a href="#" onclick="showSection('modemStatusAnalysis')">Analisis Status Modem</a>
                        </li>
                        <li>
                            <a href="#" onclick="showSection('salesCodeStatusAnalysis')">Analisis Status per Sales Code</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-info d-block d-lg-none">
                        <i class="fas fa-align-left"></i>
                        <span>Menu</span>
                    </button>
                    <h2 class="ml-auto mb-0 navbar-title">Dashboard Data Customer Biznet Branch Kalianda</h2>
                </div>
            </nav>

            <section id="customerOverview" class="content-section">
                <div class="card p-4 shadow-sm mb-4">
                    <h2 class="text-center mb-4">Daftar Customer</h2>

                    <div class="row mb-4 align-items-end">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="searchCustomer">Pencarian Customer:</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    </div>
                                    <input type="text" class="form-control" id="searchCustomer" placeholder="Cari berdasarkan nama, email, atau ID...">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterStatus">Filter Status:</label>
                                <select class="form-control" id="filterStatus">
                                    <option value="">Semua Status</option>
                                    <option value="ACTIVE">ACTIVE</option>
                                    <option value="SUSPENDED">SUSPENDED</option>
                                    <option value="TERMINATED">TERMINATED</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterSalesCode">Filter Sales Code:</label>
                                <select class="form-control" id="filterSalesCode">
                                    <option value="">Semua Sales Code</option>
                                    </select>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary btn-block" id="applyFiltersBtn">
                                <i class="fas fa-sync-alt"></i> Apply
                            </button>
                        </div>
                    </div>

                    <div id="totalCustomerDisplay" class="alert alert-info text-center" role="alert">
                        Memuat jumlah customer...
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="customerTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>BUSINESSPARTNERID</th>
                                    <th>BP_FULLNAME</th>
                                    <th>BP_EMAIL</th>
                                    <th>BP_PHONE</th>
                                    <th>CONTRACTACCOUNT</th>
                                    <th>BILLING_NAME</th>
                                    <th>BILLING_EMAIL</th>
                                    <th>BILLING_PHONE</th>
                                    <th>CONTRACTNUMBER</th>
                                    <th>SERVICE_TYPE</th>
                                    <th>SALESCODE</th>
                                    <th>BRANCH_FROM_SALESCODE</th>
                                    <th>RO_FROM_SALESCODE</th>
                                    <th>SM_FROM_SALESCODE</th>
                                    <th>BUNDLE_LOB</th>
                                    <th>BUNDLE_ID</th>
                                    <th>BUNDLE_NAME</th>
                                    <th>MODEM_STATUS</th>
                                    <th>PROMO_CODE</th>
                                    <th>CONTRACTSTARTDATE</th>
                                    <th>EXPIREDDATE</th>
                                    <th>STATUS</th>
                                    <th>TERMDATE</th>
                                    <th>ADDRESSID</th>
                                    <th>ADDRESSTYPE</th>
                                    <th>ADDRESSID_INST</th>
                                    <th>SUBDISTRICT_INST</th>
                                    <th>DISTRICT_INST</th>
                                    <th>CITY_INST</th>
                                    <th>STATE_INST</th>
                                    <th>INSTALLATION_ADDRESS1</th>
                                    <th>INSTALLATION_ADDRESS2</th>
                                    <th>INSTALLATION_ADDRESS3</th>
                                    <th>INSTALLATION_ADDRESS4</th>
                                    <th>MATERIAL_NAME</th>
                                    <th>MATERIAL_DESCRIPTION</th>
                                    <th>TOTAL_TICKET</th>
                                    <th>MODEM_TYPE</th>
                                    <th>DEVICE_MODEL</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>

                    <nav>
                        <ul class="pagination justify-content-center" id="customerPagination">
                            </ul>
                    </nav>

                    <div class="modal fade" id="customerDetailModal" tabindex="-1" aria-labelledby="customerDetailModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="customerDetailModalLabel">Detail Customer</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body" id="customerDetailBody">
                                    </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                                    <button type="button" class="btn btn-info" id="showVaButton">Tampilkan VA Pembayaran</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="vaModal" tabindex="-1" aria-labelledby="vaModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content va-print-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="vaModalLabel">Berikut nomor Virtual Account Pembayarannya:</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body" id="vaDetailBody">
                                    </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" id="downloadVaBtn">Download sebagai JPG</button>
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="chartDetailModal" tabindex="-1" aria-labelledby="chartDetailModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="chartDetailModalLabel">Detail Customer untuk Analisis</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered table-hover" id="chartCustomerDetailTable">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>BP_FULLNAME</th>
                                                    <th>CONTRACTNUMBER</th>
                                                    <th>SALESCODE</th>
                                                    <th>CONTRACTSTARTDATE</th>
                                                    <th>STATUS</th>
                                                    <th>BUNDLE_NAME</th>
                                                    <th>SUBDISTRICT_INST</th>
                                                    </tr>
                                            </thead>
                                            <tbody>
                                                </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <section id="newCustomerAnalysis" class="content-section d-none">
                <div class="card p-3 shadow-sm">
                    <h3 class="card-title text-center">Customer Baru per Bulan (per Sales Code)</h3>
                    <div class="chart-container">
                        <canvas id="customerChart"></canvas>
                    </div>
                    <div id="customerChartError" class="alert alert-danger mt-3 d-none">Gagal memuat data customer baru.</div>
                </div>
            </section>

            <section id="customerStatusAnalysis" class="content-section d-none">
                <div class="card p-3 shadow-sm">
                    <h3 class="card-title text-center">Status Customer per Sales Code</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="customerStatusTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Sales Code</th>
                                    <th>ACTIVE</th>
                                    <th>SUSPENDED</th>
                                    <th>TERMINATED</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                    <div id="customerStatusError" class="alert alert-danger mt-3 d-none">Gagal memuat data analisis status.</div>
                </div>
            </section>

            <section id="kecamatanAnalysis" class="content-section d-none">
                <div class="card p-3 shadow-sm">
                    <h3 class="card-title text-center">Distribusi Customer per Sales Code (Berdasarkan Kecamatan)</h3>
                    <div class="form-group">
                        <label for="salesCodeKecamatanFilter">Pilih Sales Code:</label>
                        <select class="form-control" id="salesCodeKecamatanFilter">
                            </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="kecamatanChart"></canvas>
                    </div>
                    <div id="kecamatanChartError" class="alert alert-danger mt-3 d-none">Gagal memuat data analisis kecamatan.</div>
                </div>
            </section>

            <section id="bundleNameAnalysis" class="content-section d-none">
                <div class="card p-3 shadow-sm">
                    <h3 class="card-title text-center">Analisis Customer per Tipe Bundle Name</h3>
                    <div class="chart-container">
                        <canvas id="bundleNameChart"></canvas>
                    </div>
                    <div id="bundleNameError" class="alert alert-danger mt-3 d-none">Gagal memuat data analisis Bundle Name.</div>
                </div>
            </section>

            <section id="modemStatusAnalysis" class="content-section d-none">
                <div class="card p-3 shadow-sm">
                    <h3 class="card-title text-center">Analisis Customer per Status Modem</h3>
                    <div class="chart-container">
                        <canvas id="modemStatusChart"></canvas>
                    </div>
                    <div id="modemStatusError" class="alert alert-danger mt-3 d-none">Gagal memuat data analisis Status Modem.</div>
                </div>
            </section>

            <section id="salesCodeStatusAnalysis" class="content-section d-none">
                <div class="card p-3 shadow-sm">
                    <h3 class="card-title text-center">Analisis Status Customer (Suspend & Terminated) per Sales Code</h3>
                    <div class="form-group">
                        <label for="salesCodeStatusFilter">Pilih Sales Code:</label>
                        <select class="form-control" id="salesCodeStatusFilter">
                            <option value="">Semua Sales Code</option>
                            </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesCodeStatusChart"></canvas>
                    </div>
                    <div id="salesCodeStatusChartError" class="alert alert-danger mt-3 d-none">Gagal memuat data analisis status per Sales Code.</div>
                </div>
            </section>


        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // --- KONFIGURASI URL APPS SCRIPT ---
        // GANTI DENGAN URL APPS SCRIPT ANDA
        const customerWebAppUrl = 'https://script.google.com/macros/s/AKfycbxx2V5MzkTUrtFY4cbLfyjE51cdZoahXEodZzg7H30qwxFgIABfNiI2DZ8A1fSNLpkhZQ/exec'; 

        // --- GLOBAL VARIABLES ---
        let allCustomers = [];
        let filteredCustomers = [];
        const itemsPerPage = 10;
        let currentPage = 1;

        // Sales Code to Name mapping
        const salesCodeNames = {
            '200602': 'Riski Aprianto',
            '200603': 'Habibi',
            '200604': 'Ananda Ilham Hakiki'
        };

        // Chart instances
        let customerChartInstance = null;
        let kecamatanChartInstance = null;
        let bundleNameChartInstance = null;
        let modemStatusChartInstance = null;
        let salesCodeStatusChartInstance = null;

        // --- UTILITY FUNCTIONS ---
        const formatNumber = (num) => new Intl.NumberFormat('id-ID').format(num);

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('d-none');
            });
            document.getElementById(sectionId).classList.remove('d-none');

            // Update active state in sidebar
            document.querySelectorAll('#sidebar ul li').forEach(li => li.classList.remove('active'));
            const clickedLink = document.querySelector(`#sidebar a[onclick="showSection('${sectionId}')"]`);
            if (clickedLink) {
                clickedLink.parentElement.classList.add('active');
                // If it's in a submenu, also activate the parent
                if (clickedLink.closest('.collapse')) {
                    const parentLi = clickedLink.closest('.collapse').previousElementSibling.parentElement;
                    if (parentLi) {
                        parentLi.classList.add('active');
                        // Ensure the dropdown is open
                        $(clickedLink.closest('.collapse')).collapse('show');
                    }
                }
            }

            // Render charts relevant to the section when it's shown
            if (sectionId === 'newCustomerAnalysis') renderCustomerChart();
            if (sectionId === 'customerStatusAnalysis') renderCustomerStatusTable();
            if (sectionId === 'kecamatanAnalysis') renderKecamatanChart();
            if (sectionId === 'bundleNameAnalysis') renderBundleNameChart();
            if (sectionId === 'modemStatusAnalysis') renderModemStatusChart();
            if (sectionId === 'salesCodeStatusAnalysis') renderSalesCodeStatusChart();
            
            // For mobile, close sidebar when a section is selected
            if (window.innerWidth <= 768) {
                $('#sidebar').removeClass('active');
            }
        }

        // --- FETCH DATA FUNCTIONS ---
        async function fetchCustomerData() {
            try {
                const response = await fetch(customerWebAppUrl);
                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }
                allCustomers = result;
                filteredCustomers = [...allCustomers];
                document.getElementById('totalCustomerDisplay').textContent = `Menampilkan ${filteredCustomers.length} dari ${allCustomers.length} Customer.`;
                populateSalesCodeFilter();
                renderCustomerTable(currentPage);
                renderAllCharts();
            } catch (error) {
                console.error('Error fetching customer data:', error);
                document.getElementById('totalCustomerDisplay').textContent = `Gagal memuat jumlah customer. Error: ${error.message}.`;
                document.getElementById('customerChartError').classList.remove('d-none');
                document.getElementById('customerChartError').textContent = `Gagal memuat data customer baru. Error: ${error.message}`;
                document.getElementById('customerStatusError').classList.remove('d-none');
                document.getElementById('customerStatusError').textContent = `Gagal memuat data analisis status. Error: ${error.message}`;
                document.getElementById('kecamatanChartError').classList.remove('d-none');
                document.getElementById('kecamatanChartError').textContent = `Gagal memuat data analisis kecamatan. Error: ${error.message}`;
                document.getElementById('bundleNameError').classList.remove('d-none');
                document.getElementById('bundleNameError').textContent = `Gagal memuat data analisis Bundle Name. Error: ${error.message}`;
                document.getElementById('modemStatusError').classList.remove('d-none');
                document.getElementById('modemStatusError').textContent = `Gagal memuat data analisis Status Modem. Error: ${error.message}`;
                document.getElementById('salesCodeStatusChartError').classList.remove('d-none');
                document.getElementById('salesCodeStatusChartError').textContent = `Gagal memuat data analisis status per Sales Code. Error: ${error.message}`;


                // Also display error on table
                const tableBody = document.querySelector('#customerTable tbody');
                tableBody.innerHTML = `<tr><td colspan="38" class="text-center text-danger">Gagal memuat data: ${error.message}. Pastikan Google Sheet Anda dapat diakses dan Apps Script berjalan dengan benar.</td></tr>`;
            }
        }

        // --- CUSTOMER TABLE & PAGINATION ---
        function renderCustomerTable(page) {
            const tableBody = document.querySelector('#customerTable tbody');
            tableBody.innerHTML = '';
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filteredCustomers.slice(startIndex, endIndex);

            const customerHeaders = [
                'BUSINESSPARTNERID', 'BP_FULLNAME', 'BP_EMAIL', 'BP_PHONE', 'CONTRACTACCOUNT',
                'BILLING_NAME', 'BILLING_EMAIL', 'BILLING_PHONE', 'CONTRACTNUMBER', 'SERVICE_TYPE',
                'SALESCODE', 'BRANCH_FROM_SALESCODE', 'RO_FROM_SALESCODE', 'SM_FROM_SALESCODE',
                'BUNDLE_LOB', 'BUNDLE_ID', 'BUNDLE_NAME', 'MODEM_STATUS', 'PROMO_CODE',
                'CONTRACTSTARTDATE', 'EXPIREDDATE', 'STATUS', 'TERMDATE', 'ADDRESSID',
                'ADDRESSTYPE', 'ADDRESSID_INST', 'SUBDISTRICT_INST', 'DISTRICT_INST',
                'CITY_INST', 'STATE_INST', 'INSTALLATION_ADDRESS1', 'INSTALLATION_ADDRESS2',
                'INSTALLATION_ADDRESS3', 'INSTALLATION_ADDRESS4', 'MATERIAL_NAME',
                'MATERIAL_DESCRIPTION', 'TOTAL_TICKET', 'MODEM_TYPE', 'DEVICE_MODEL'
            ];

            if (paginatedItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="38" class="text-center">Tidak ada data customer yang ditemukan.</td></tr>`;
            } else {
                paginatedItems.forEach(customer => {
                    const row = tableBody.insertRow();
                    customerHeaders.forEach(header => {
                        const cell = row.insertCell();
                        cell.textContent = customer[header] || '-';
                    });
                    row.style.cursor = 'pointer';
                    row.onclick = () => showCustomerDetail(customer);
                });
            }
            renderPagination(filteredCustomers.length, page);
        }

        function renderPagination(totalItems, currentPage) {
            const paginationUl = document.getElementById('customerPagination');
            paginationUl.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage === totalPages && endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevA = document.createElement('a');
            prevA.className = 'page-link';
            prevA.href = '#';
            prevA.innerHTML = '&laquo;';
            prevA.onclick = (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    renderCustomerTable(currentPage);
                }
            };
            prevLi.appendChild(prevA);
            paginationUl.appendChild(prevLi);

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.onclick = (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderCustomerTable(currentPage);
                };
                li.appendChild(a);
                paginationUl.appendChild(li);
            }

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextA = document.createElement('a');
            nextA.className = 'page-link';
            nextA.href = '#';
            nextA.innerHTML = '&raquo;';
            nextA.onclick = (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCustomerTable(currentPage);
                }
            };
            nextLi.appendChild(nextA);
            paginationUl.appendChild(nextLi);
        }


        function showCustomerDetail(customer) {
            const detailBody = document.getElementById('customerDetailBody');
            detailBody.innerHTML = `
                <p><strong>Business Partner ID:</strong> ${customer.BUSINESSPARTNERID || '-'}</p>
                <p><strong>Nama Lengkap:</strong> ${customer.BP_FULLNAME || '-'}</p>
                <p><strong>Email:</strong> ${customer.BP_EMAIL || '-'}</p>
                <p><strong>Telepon:</strong> ${customer.BP_PHONE || '-'}</p>
                <p><strong>Contract Account:</strong> ${customer.CONTRACTACCOUNT || '-'}</p>
                <p><strong>Nama Billing:</strong> ${customer.BILLING_NAME || '-'}</p>
                <p><strong>Email Billing:</strong> ${customer.BILLING_EMAIL || '-'}</p>
                <p><strong>Telepon Billing:</strong> ${customer.BILLING_PHONE || '-'}</p>
                <p><strong>Nomor Kontrak:</strong> ${customer.CONTRACTNUMBER || '-'}</p>
                <p><strong>Tipe Layanan:</strong> ${customer.SERVICE_TYPE || '-'}</p>
                <p><strong>Sales Code:</strong> ${customer.SALESCODE || '-'} ${salesCodeNames[customer.SALESCODE] ? `(${salesCodeNames[customer.SALESCODE]})` : ''}</p>
                <p><strong>Cabang dari Sales Code:</strong> ${customer.BRANCH_FROM_SALESCODE || '-'}</p>
                <p><strong>RO dari Sales Code:</strong> ${customer.RO_FROM_SALESCODE || '-'}</p>
                <p><strong>SM dari Sales Code:</strong> ${customer.SM_FROM_SALESCODE || '-'}</p>
                <p><strong>Bundle LOB:</strong> ${customer.BUNDLE_LOB || '-'}</p>
                <p><strong>ID Bundle:</strong> ${customer.BUNDLE_ID || '-'}</p>
                <p><strong>Nama Bundle:</strong> ${customer.BUNDLE_NAME || '-'}</p>
                <p><strong>Status Modem:</strong> ${customer.MODEM_STATUS || '-'}</p>
                <p><strong>Kode Promo:</strong> ${customer.PROMO_CODE || '-'}</p>
                <p><strong>Tanggal Mulai Kontrak:</strong> ${customer.CONTRACTSTARTDATE || '-'}</p>
                <p><strong>Tanggal Kadaluarsa:</strong> ${customer.EXPIREDDATE || '-'}</p>
                <p><strong>Status:</strong> ${customer.STATUS || '-'}</p>
                <p><strong>Tanggal Berakhir:</strong> ${customer.TERMDATE || '-'}</p>
                <p><strong>ID Alamat:</strong> ${customer.ADDRESSID || '-'}</p>
                <p><strong>Tipe Alamat:</strong> ${customer.ADDRESSTYPE || '-'}</p>
                <p><strong>ID Alamat Instalasi:</strong> ${customer.ADDRESSID_INST || '-'}</p>
                <p><strong>Kecamatan Instalasi:</strong> ${customer.SUBDISTRICT_INST || '-'}</p>
                <p><strong>Kabupaten/Kota Instalasi:</strong> ${customer.DISTRICT_INST || '-'}</p>
                <p><strong>Kota Instalasi:</strong> ${customer.CITY_INST || '-'}</p>
                <p><strong>Provinsi Instalasi:</strong> ${customer.STATE_INST || '-'}</p>
                <p><strong>Alamat Instalasi 1:</strong> ${customer.INSTALLATION_ADDRESS1 || '-'}</p>
                <p><strong>Alamat Instalasi 2:</strong> ${customer.INSTALLATION_ADDRESS2 || '-'}</p>
                <p><strong>Alamat Instalasi 3:</strong> ${customer.INSTALLATION_ADDRESS3 || '-'}</p>
                <p><strong>Alamat Instalasi 4:</strong> ${customer.INSTALLATION_ADDRESS4 || '-'}</p>
                <p><strong>Nama Material:</strong> ${customer.MATERIAL_NAME || '-'}</p>
                <p><strong>Deskripsi Material:</strong> ${customer.MATERIAL_DESCRIPTION || '-'}</p>
                <p><strong>Total Tiket:</strong> ${customer.TOTAL_TICKET || '-'}</p>
                <p><strong>Tipe Modem:</strong> ${customer.MODEM_TYPE || '-'}</p>
                <p><strong>Model Perangkat:</strong> ${customer.DEVICE_MODEL || '-'}</p>
            `;
            $('#customerDetailModal').modal('show');

            document.getElementById('showVaButton').onclick = () => showVaDetail(customer);
        }

        function showVaDetail(customer) {
            const vaDetailBody = document.getElementById('vaDetailBody');
            let vaHtmlContent = `
                <div class="text-center mb-3">
                    <img src="logo-biznet-blue-trans.png" alt="Biznet Logo" class="img-fluid" style="max-height: 50px;">
                </div>
            `;

            vaHtmlContent += `
                <p><strong>Nama Customer:</strong> ${customer.BP_FULLNAME || '-'}</p>
                <p><strong>Masa aktif sampai:</strong> ${customer.EXPIREDDATE || '-'}</p>
            `;

            // Logic for Metronet vs. Home/other bundles
            if (customer.BUNDLE_LOB && customer.BUNDLE_LOB.toUpperCase() === 'METRONET') {
                vaHtmlContent += `
                    <p><strong>Pembayaran melalui Virtual Account</strong></p>
                    <p><strong>Payment via Virtual Account</strong></p>
                    <p><strong>BCA:</strong> ${customer.CONTRACTACCOUNT ? `711160-${customer.CONTRACTACCOUNT}` : '-'}</p>
                    <p><strong>Bank Permata:</strong> ${customer.CONTRACTACCOUNT ? `883100-${customer.CONTRACTACCOUNT}` : '-'}</p>
                    <p><strong>Bank Mandiri:</strong> ${customer.CONTRACTACCOUNT ? `895912-${customer.CONTRACTACCOUNT}` : '-'}</p>
                    <p><strong>OCBC:</strong> ${customer.CONTRACTACCOUNT ? `903022-${customer.CONTRACTACCOUNT}` : '-'}</p>
                    <p><strong>Billing ID:</strong> ${customer.CONTRACTACCOUNT || '-'}</p>
                `;
            } else {
                vaHtmlContent += `
                    <p><strong>Bank Permata Virtual Account:</strong> ${customer.CONTRACTACCOUNT ? `899300-${customer.CONTRACTACCOUNT}` : '-'}</p>
                    <p><strong>Bank BCA Virtual Account:</strong> ${customer.CONTRACTACCOUNT ? `711170-${customer.CONTRACTACCOUNT}` : '-'}</p>
                    <p><strong>Bank Mandiri Virtual Account:</strong> ${customer.CONTRACTACCOUNT ? `895911-${customer.CONTRACTACCOUNT}` : '-'}</p>
                    <p><strong>MBanking UOB / Indomaret / Alfamart / Alfamidi / CK / GoPay / Tokopedia / BRIMO / DANA:</strong></p>
                    <p><strong>Billing ID:</strong> ${customer.CONTRACTACCOUNT || '-'}</p>
                `;
            }

            vaDetailBody.innerHTML = vaHtmlContent;
            $('#vaModal').modal('show');

            document.getElementById('downloadVaBtn').onclick = () => downloadVaAsJpg(customer);
        }

        function downloadVaAsJpg(customer) {
            const vaModalContent = document.getElementById('vaModal').querySelector('.va-print-content');
            html2canvas(vaModalContent, {
                scale: 2,
                useCORS: true,
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `VA_Customer_${(customer.BP_FULLNAME || 'Unknown').replace(/\s/g, '_')}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            }).catch(error => {
                console.error("Gagal membuat gambar VA:", error);
                alert("Gagal membuat gambar VA. Silakan coba lagi. Pastikan logo-biznet-blue-trans.png berada di direktori yang sama.");
            });
        }

        // --- FILTERING ---
        function applyFilters() {
            const searchTerm = document.getElementById('searchCustomer').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const salesCodeFilter = document.getElementById('filterSalesCode').value;

            filteredCustomers = allCustomers.filter(customer => {
                const matchesSearch = searchTerm === '' ||
                    (customer.BP_FULLNAME && customer.BP_FULLNAME.toLowerCase().includes(searchTerm)) ||
                    (customer.BP_EMAIL && customer.BP_EMAIL.toLowerCase().includes(searchTerm)) ||
                    (customer.BUSINESSPARTNERID && customer.BUSINESSPARTNERID.toLowerCase().includes(searchTerm));

                const matchesStatus = statusFilter === '' ||
                    (customer.STATUS && customer.STATUS.toUpperCase() === statusFilter.toUpperCase());

                const matchesSalesCode = salesCodeFilter === '' ||
                    (customer.SALESCODE && customer.SALESCODE === salesCodeFilter);

                return matchesSearch && matchesStatus && matchesSalesCode;
            });
            currentPage = 1;
            document.getElementById('totalCustomerDisplay').textContent = `Menampilkan ${filteredCustomers.length} dari ${allCustomers.length} Customer.`;
            renderCustomerTable(currentPage);
            renderAllCharts();
        }

        function populateSalesCodeFilter() {
            const salesCodeSelect = document.getElementById('filterSalesCode');
            salesCodeSelect.innerHTML = '<option value="">Semua Sales Code</option>';
            const salesCodeStatusSelect = document.getElementById('salesCodeStatusFilter');
            salesCodeStatusSelect.innerHTML = '<option value="">Semua Sales Code</option>';

            if (allCustomers && allCustomers.length > 0) {
                const salesCodes = [...new Set(allCustomers.map(c => c.SALESCODE).filter(Boolean))].sort();
                salesCodes.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = salesCodeNames[code] ? `${salesCodeNames[code]} (${code})` : code;
                    salesCodeSelect.appendChild(option);
                    salesCodeStatusSelect.appendChild(option.cloneNode(true));
                });
            } else {
                console.warn("allCustomers is empty, cannot populate sales code filter.");
            }

            const salesCodeKecamatanSelect = document.getElementById('salesCodeKecamatanFilter');
            salesCodeKecamatanSelect.innerHTML = '<option value="">Pilih Sales Code</option>';
            if (allCustomers && allCustomers.length > 0) {
                 const salesCodesKecamatan = [...new Set(allCustomers.map(c => c.SALESCODE).filter(Boolean))].sort();
                 salesCodesKecamatan.forEach(code => {
                     const option = document.createElement('option');
                     option.value = code;
                     option.textContent = salesCodeNames[code] ? `${salesCodeNames[code]} (${code})` : code;
                     salesCodeKecamatanSelect.appendChild(option);
                 });
             }
        }


        // --- CHARTING FUNCTIONS ---
        function renderAllCharts() {
            if (!document.getElementById('newCustomerAnalysis').classList.contains('d-none')) renderCustomerChart();
            if (!document.getElementById('customerStatusAnalysis').classList.contains('d-none')) renderCustomerStatusTable();
            if (!document.getElementById('kecamatanAnalysis').classList.contains('d-none')) renderKecamatanChart();
            if (!document.getElementById('bundleNameAnalysis').classList.contains('d-none')) renderBundleNameChart();
            if (!document.getElementById('modemStatusAnalysis').classList.contains('d-none')) renderModemStatusChart();
            if (!document.getElementById('salesCodeStatusAnalysis').classList.contains('d-none')) renderSalesCodeStatusChart();
        }

        function parseDate(dateString) {
            if (!dateString) {
                return null;
            }

            const partsDash = dateString.split('-');
            if (partsDash.length === 3) {
                const year = parseInt(partsDash[0], 10);
                const month = parseInt(partsDash[1], 10) - 1;
                const day = parseInt(partsDash[2], 10);
                const date = new Date(year, month, day);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }

            const partsSlash = dateString.split('/');
            if (partsSlash.length === 3) {
                const day = parseInt(partsSlash[0], 10);
                const month = parseInt(partsSlash[1], 10) - 1;
                let year = parseInt(partsSlash[2], 10);

                if (year < 100) {
                    year = (year < 70) ? (2000 + year) : (1900 + year);
                }
                const date = new Date(year, month, day);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }

            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } catch (e) {
                console.error("Failed to parse date string:", dateString, e);
            }
            return null;
        }

        function renderCustomerChart() {
            const ctx = document.getElementById('customerChart');
            if (!ctx) return;
            const context = ctx.getContext('2d');

            if (customerChartInstance) {
                customerChartInstance.destroy();
            }

            const monthlyCustomerData = {};
            const allSalesCodes = new Set();
            const allMonths = new Set();

            filteredCustomers.forEach(customer => {
                const contractDate = parseDate(customer.CONTRACTSTARTDATE);
                if (contractDate) {
                    const yearMonth = `${contractDate.getFullYear()}-${(contractDate.getMonth() + 1).toString().padStart(2, '0')}`;
                    allMonths.add(yearMonth);

                    const salesCode = customer.SALESCODE || 'Tidak Diketahui';
                    allSalesCodes.add(salesCode);

                    if (!monthlyCustomerData[yearMonth]) {
                        monthlyCustomerData[yearMonth] = {};
                    }
                    monthlyCustomerData[yearMonth][salesCode] = (monthlyCustomerData[yearMonth][salesCode] || 0) + 1;
                }
            });

            const sortedMonths = Array.from(allMonths).sort();
            const sortedSalesCodes = Array.from(allSalesCodes).sort((a, b) => {
                if (a === 'Tidak Diketahui') return 1;
                if (b === 'Tidak Diketahui') return -1;
                return a.localeCompare(b);
            });

            const datasets = sortedSalesCodes.map(salesCode => {
                const data = sortedMonths.map(month => monthlyCustomerData[month] ? (monthlyCustomerData[month][salesCode] || 0) : 0);
                return {
                    label: salesCodeNames[salesCode] ? `${salesCodeNames[salesCode]} (${salesCode})` : salesCode,
                    data: data,
                    fill: false,
                    tension: 0.1,
                    borderColor: getRandomColor(),
                    pointRadius: 5,
                    pointHoverRadius: 8
                };
            });

            if (datasets.length === 0 || sortedMonths.length === 0 || datasets.every(ds => ds.data.every(d => d === 0))) {
                 context.clearRect(0, 0, ctx.width, ctx.height);
                 document.getElementById('customerChartError').classList.remove('d-none');
                 document.getElementById('customerChartError').textContent = 'Tidak ada data customer baru yang sesuai dengan filter.';
                 return;
            } else {
                 document.getElementById('customerChartError').classList.add('d-none');
            }


            customerChartInstance = new Chart(context, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        },
                        title: {
                            display: false,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Jumlah Customer Baru'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    onClick: (event, elements, chart) => {
                        if (elements.length > 0) {
                            const firstElement = elements[0];
                            const datasetIndex = firstElement.datasetIndex;
                            const dataIndex = firstElement.index;

                            const clickedSalesCode = sortedSalesCodes[datasetIndex];
                            const clickedMonth = sortedMonths[dataIndex];

                            showCustomersForChartPoint('SALESCODE', clickedSalesCode, clickedMonth, 'CONTRACTSTARTDATE', ['ACTIVE', 'SUSPENDED', 'TERMINATED']); // Include all statuses for new customers
                        }
                    }
                }
            });
        }

        // Updated showCustomersForChartPoint to be more generic
        // keyColumn: 'SALESCODE' or 'RO_FROM_SALESCODE' or 'SM_FROM_SALESCODE'
        // keyFilterValue: The actual value (e.g., '200602', 'RM02 PALEMBANG - SUMATRA 2')
        // dateFilterValue: 'YYYY-MM'
        // dateColumn: 'CONTRACTSTARTDATE', 'EXPIREDDATE', or 'TERMDATE'
        // statusFilters: Array of statuses (e.g., ['ACTIVE'], ['SUSPENDED'], ['TERMINATED'])
        function showCustomersForChartPoint(keyColumn, keyFilterValue, dateFilterValue, dateColumn, statusFilters = []) {
            const [year, monthNum] = dateFilterValue.split('-').map(Number);

            const relevantCustomers = filteredCustomers.filter(customer => {
                const dateToFilter = parseDate(customer[dateColumn]);
                if (dateToFilter) {
                    const customerYear = dateToFilter.getFullYear();
                    const customerMonth = dateToFilter.getMonth() + 1;

                    // Check if the date matches the clicked month/year
                    const dateMatch = customerYear === year && customerMonth === monthNum;

                    // Check if the key (Sales Code or ARCO) matches
                    let keyMatch = false;
                    // If keyFilterValue is 'All', it means we are not filtering by a specific key value
                    if (keyFilterValue === 'All') {
                        keyMatch = true;
                    } else if (customer[keyColumn] === keyFilterValue) {
                        keyMatch = true;
                    }

                    // Check if the status matches
                    const customerStatus = (customer.STATUS || '').toUpperCase();
                    const statusMatch = statusFilters.length === 0 || statusFilters.includes(customerStatus);
                    
                    return dateMatch && keyMatch && statusMatch;
                }
                return false;
            });

            const modalBodyTable = document.querySelector('#chartDetailModal #chartCustomerDetailTable tbody');
            modalBodyTable.innerHTML = ''; // Clear previous data

            if (relevantCustomers.length === 0) {
                modalBodyTable.innerHTML = `<tr><td colspan="7" class="text-center">Tidak ada customer untuk kriteria ini.</td></tr>`;
            } else {
                relevantCustomers.forEach(customer => {
                    const row = modalBodyTable.insertRow();
                    row.insertCell().textContent = customer.BP_FULLNAME || '-';
                    row.insertCell().textContent = customer.CONTRACTNUMBER || '-';
                    row.insertCell().textContent = customer.SALESCODE || '-';
                    row.insertCell().textContent = customer.CONTRACTSTARTDATE || '-';
                    row.insertCell().textContent = customer.STATUS || '-';
                    row.insertCell().textContent = customer.BUNDLE_NAME || '-';
                    row.insertCell().textContent = customer.SUBDISTRICT_INST || '-';
                });
            }

            let titlePrefix = '';
            let keyLabel = keyFilterValue;
            if (keyColumn === 'SALESCODE' && salesCodeNames[keyFilterValue]) {
                keyLabel = `${salesCodeNames[keyFilterValue]} (${keyFilterValue})`;
            } else if (keyFilterValue === 'All') {
                keyLabel = 'Semua Sales Code';
            }


            if (dateColumn === 'CONTRACTSTARTDATE') {
                titlePrefix = `Customer Baru untuk ${keyLabel}`;
            } else if (dateColumn === 'EXPIREDDATE') {
                titlePrefix = `Customer Suspended untuk ${keyLabel}`;
            } else if (dateColumn === 'TERMDATE') {
                titlePrefix = `Customer Terminated untuk ${keyLabel}`;
            }

            document.getElementById('chartDetailModalLabel').textContent = `${titlePrefix} pada Bulan ${dateFilterValue}`;
            $('#chartDetailModal').modal('show');
        }


        function renderCustomerStatusTable() {
            const tableBody = document.querySelector('#customerStatusTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const statusBySalesCode = {};
            filteredCustomers.forEach(customer => {
                const salesCode = customer.SALESCODE || 'Tidak Diketahui';
                const status = customer.STATUS ? customer.STATUS.toUpperCase() : 'Tidak Diketahui';

                if (!statusBySalesCode[salesCode]) {
                    statusBySalesCode[salesCode] = { ACTIVE: 0, SUSPENDED: 0, TERMINATED: 0, 'Tidak Diketahui': 0, Total: 0 };
                }
                statusBySalesCode[salesCode][status]++;
                statusBySalesCode[salesCode].Total++;
            });

            const sortedSalesCodes = Object.keys(statusBySalesCode).sort();

            if (sortedSalesCodes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Tidak ada data status customer yang ditemukan.</td></tr>`;
                document.getElementById('customerStatusError').classList.remove('d-none');
                document.getElementById('customerStatusError').textContent = 'Tidak ada data status customer yang sesuai dengan filter.';
                return;
            }
            document.getElementById('customerStatusError').classList.add('d-none');


            sortedSalesCodes.forEach(salesCode => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = salesCodeNames[salesCode] ? `${salesCodeNames[salesCode]} (${salesCode})` : salesCode;
                row.insertCell().textContent = statusBySalesCode[salesCode].ACTIVE;
                row.insertCell().textContent = statusBySalesCode[salesCode].SUSPENDED;
                row.insertCell().textContent = statusBySalesCode[salesCode].TERMINATED;
                row.insertCell().textContent = statusBySalesCode[salesCode].Total;
            });
        }

        function renderKecamatanChart() {
            const ctx = document.getElementById('kecamatanChart');
            if (!ctx) return;
            const context = ctx.getContext('2d');

            if (kecamatanChartInstance) {
                kecamatanChartInstance.destroy();
            }

            const salesCodeKecamatanFilter = document.getElementById('salesCodeKecamatanFilter');
            let selectedSalesCode = salesCodeKecamatanFilter.value;

            if (!selectedSalesCode && salesCodeKecamatanFilter.options.length > 1) {
                selectedSalesCode = salesCodeKecamatanFilter.options[1].value;
                salesCodeKecamatanFilter.value = selectedSalesCode;
            }

            const customerInSelectedSalesCode = filteredCustomers.filter(c => c.SALESCODE === selectedSalesCode);
            const kecamatanCounts = {};
            customerInSelectedSalesCode.forEach(customer => {
                const kecamatan = customer.SUBDISTRICT_INST || 'Tidak Diketahui';
                kecamatanCounts[kecamatan] = (kecamatanCounts[kecamatan] || 0) + 1;
            });

            const sortedKecamatans = Object.keys(kecamatanCounts).sort((a, b) => kecamatanCounts[b] - kecamatanCounts[a]);
            const labels = sortedKecamatans;
            const data = sortedKecamatans.map(kec => kecamatanCounts[kec]);

            if (data.length === 0) {
                context.clearRect(0, 0, ctx.width, ctx.height);
                document.getElementById('kecamatanChartError').classList.remove('d-none');
                document.getElementById('kecamatanChartError').textContent = 'Tidak ada data kecamatan untuk Sales Code ini.';
                return;
            } else {
                document.getElementById('kecamatanChartError').classList.add('d-none');
            }


            kecamatanChartInstance = new Chart(context, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Customer',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `Distribusi Customer per Kecamatan untuk ${salesCodeNames[selectedSalesCode] ? `${salesCodeNames[selectedSalesCode]} (${selectedSalesCode})` : selectedSalesCode}`
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (value) => value,
                            color: '#333'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Customer'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Kecamatan'
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }


        function renderBundleNameChart() {
            const ctx = document.getElementById('bundleNameChart');
            if (!ctx) return;
            const context = ctx.getContext('2d');

            if (bundleNameChartInstance) {
                bundleNameChartInstance.destroy();
            }

            const bundleNameCounts = {};
            filteredCustomers.forEach(customer => {
                const bundleName = customer.BUNDLE_NAME || 'Tidak Diketahui';
                bundleNameCounts[bundleName] = (bundleNameCounts[bundleName] || 0) + 1;
            });

            const sortedBundleNames = Object.keys(bundleNameCounts).sort((a, b) => bundleNameCounts[b] - bundleNameCounts[a]);
            const labels = sortedBundleNames;
            const data = sortedBundleNames.map(name => bundleNameCounts[name]);
            const backgroundColors = labels.map(() => getRandomColor(0.7));
            const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

            if (data.length === 0) {
                context.clearRect(0, 0, ctx.width, ctx.height);
                document.getElementById('bundleNameError').classList.remove('d-none');
                document.getElementById('bundleNameError').textContent = 'Tidak ada data Bundle Name yang ditemukan.';
                return;
            } else {
                document.getElementById('bundleNameError').classList.add('d-none');
            }

            bundleNameChartInstance = new Chart(context, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Customer',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Customer per Tipe Bundle Name'
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (value) => value,
                            color: '#333'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tipe Bundle Name'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Jumlah Customer'
                            },
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderModemStatusChart() {
            const ctx = document.getElementById('modemStatusChart');
            if (!ctx) return;
            const context = ctx.getContext('2d');

            if (modemStatusChartInstance) {
                modemStatusChartInstance.destroy();
            }

            const modemStatusCounts = {};
            filteredCustomers.forEach(customer => {
                const modemStatus = customer.MODEM_STATUS || 'Tidak Diketahui';
                modemStatusCounts[modemStatus] = (modemStatusCounts[modemStatus] || 0) + 1;
            });

            const labels = Object.keys(modemStatusCounts);
            const data = Object.values(modemStatusCounts);
            const backgroundColors = labels.map(() => getRandomColor(0.7));
            const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

            if (data.length === 0) {
                context.clearRect(0, 0, ctx.width, ctx.height);
                document.getElementById('modemStatusError').classList.remove('d-none');
                document.getElementById('modemStatusError').textContent = 'Tidak ada data Status Modem yang ditemukan.';
                return;
            } else {
                document.getElementById('modemStatusError').classList.add('d-none');
            }

            modemStatusChartInstance = new Chart(context, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Customer',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Customer per Status Modem'
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => {
                                    sum += data;
                                });
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return `${ctx.chart.data.labels[ctx.dataIndex]}: ${percentage}`;
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    let sum = context.dataset.data.reduce((a, b) => a + b, 0);
                                    let percentage = (context.raw * 100 / sum).toFixed(1) + "%";
                                    return `${label} (${percentage})`;
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderSalesCodeStatusChart() {
            const ctx = document.getElementById('salesCodeStatusChart');
            if (!ctx) return;
            const context = ctx.getContext('2d');

            if (salesCodeStatusChartInstance) {
                salesCodeStatusChartInstance.destroy();
            }

            const selectedSalesCode = document.getElementById('salesCodeStatusFilter').value;

            let customersToAnalyze = filteredCustomers;
            if (selectedSalesCode) {
                customersToAnalyze = filteredCustomers.filter(customer =>
                    customer.SALESCODE === selectedSalesCode
                );
            }

            const monthlySalesCodeData = {};
            const allMonths = new Set();

            customersToAnalyze.forEach(customer => {
                if (customer.STATUS && customer.STATUS.toUpperCase() === 'SUSPENDED') {
                    const expiredDate = parseDate(customer.EXPIREDDATE);
                    if (expiredDate) {
                        const yearMonth = `${expiredDate.getFullYear()}-${(expiredDate.getMonth() + 1).toString().padStart(2, '0')}`;
                        allMonths.add(yearMonth);
                        if (!monthlySalesCodeData[yearMonth]) {
                            monthlySalesCodeData[yearMonth] = { Suspend: 0, Terminated: 0 };
                        }
                        monthlySalesCodeData[yearMonth].Suspend++;
                    }
                } else if (customer.STATUS && customer.STATUS.toUpperCase() === 'TERMINATED') {
                    const termDate = parseDate(customer.TERMDATE);
                    if (termDate) {
                        const yearMonth = `${termDate.getFullYear()}-${(termDate.getMonth() + 1).toString().padStart(2, '0')}`;
                        allMonths.add(yearMonth);
                        if (!monthlySalesCodeData[yearMonth]) {
                            monthlySalesCodeData[yearMonth] = { Suspend: 0, Terminated: 0 };
                        }
                        monthlySalesCodeData[yearMonth].Terminated++;
                    }
                }
            });

            const sortedMonths = Array.from(allMonths).sort();

            const suspendData = sortedMonths.map(month => monthlySalesCodeData[month] ? monthlySalesCodeData[month].Suspend : 0);
            const terminatedData = sortedMonths.map(month => monthlySalesCodeData[month] ? monthlySalesCodeData[month].Terminated : 0);

            const datasets = [
                {
                    label: 'Suspend',
                    data: suspendData,
                    borderColor: 'rgba(255, 159, 64, 1)',
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    tension: 0.1,
                    fill: false,
                    pointRadius: 5,
                    pointHoverRadius: 8
                },
                {
                    label: 'Terminated',
                    data: terminatedData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    tension: 0.1,
                    fill: false,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }
            ];

            if (datasets[0].data.reduce((a, b) => a + b, 0) === 0 && datasets[1].data.reduce((a, b) => a + b, 0) === 0) {
                 context.clearRect(0, 0, ctx.width, ctx.height);
                 document.getElementById('salesCodeStatusChartError').classList.remove('d-none');
                 document.getElementById('salesCodeStatusChartError').textContent = `Tidak ada data suspend atau terminated untuk Sales Code ${salesCodeNames[selectedSalesCode] ? `${salesCodeNames[selectedSalesCode]} (${selectedSalesCode})` : (selectedSalesCode || 'yang dipilih')}.`;
                 return;
            } else {
                 document.getElementById('salesCodeStatusChartError').classList.add('d-none');
            }

            salesCodeStatusChartInstance = new Chart(context, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Status Customer (Suspend & Terminated) per Bulan untuk Sales Code ${salesCodeNames[selectedSalesCode] ? `${salesCodeNames[selectedSalesCode]} (${selectedSalesCode})` : (selectedSalesCode || 'Semua Sales Code')}`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Jumlah Customer'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    onClick: (event, elements, chart) => {
                        if (elements.length > 0) {
                            const firstElement = elements[0];
                            const datasetIndex = firstElement.datasetIndex; // 0 for Suspend, 1 for Terminated
                            const dataIndex = firstElement.index;

                            const clickedMonth = sortedMonths[dataIndex];
                            const clickedStatusType = datasets[datasetIndex].label;

                            let dateColumn;
                            let statusToFilter = [];

                            if (clickedStatusType === 'Suspend') {
                                dateColumn = 'EXPIREDDATE';
                                statusToFilter = ['SUSPENDED'];
                            } else if (clickedStatusType === 'Terminated') {
                                dateColumn = 'TERMDATE';
                                statusToFilter = ['TERMINATED'];
                            }
                            
                            // Perhatikan: keyFilterValue akan menjadi selectedSalesCode saat ini dari dropdown.
                            // Jika dropdown 'Semua Sales Code' dipilih, maka selectedSalesCode akan kosong,
                            // dan showCustomersForChartPoint akan menangani ini dengan 'All'.
                            showCustomersForChartPoint('SALESCODE', selectedSalesCode || 'All', clickedMonth, dateColumn, statusToFilter);
                        }
                    }
                }
            });
        }


        function getRandomColor(alpha = 1) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // --- EVENT LISTENERS & INITIAL LOAD ---
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
        document.getElementById('searchCustomer').addEventListener('input', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterSalesCode').addEventListener('change', applyFilters);
        document.getElementById('salesCodeKecamatanFilter').addEventListener('change', renderKecamatanChart);
        document.getElementById('salesCodeStatusFilter').addEventListener('change', renderSalesCodeStatusChart);


        document.addEventListener('DOMContentLoaded', () => {
            fetchCustomerData();
            // Sidebar toggle functionality
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
            });
            showSection('customerOverview');
        });
    </script>
</body>
</html>
